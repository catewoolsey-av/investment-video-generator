<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Why We Invested â€“ Video Generator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #F6F2F8;
      --card: #FFFFFF;
      --accent: #C8E8E7;
      --accent-soft: rgba(200, 232, 231, 0.3);
      --border-light: rgba(0, 51, 73, 0.55);
      --border-medium: rgba(0, 51, 73, 0.55);
      --text: #003349;
      --text-muted: rgba(0, 51, 73, 0.6);
      --danger: #7B569B;
      --radius-lg: 18px;
      --radius-sm: 10px;
      --shadow-soft: 0 4px 20px rgba(0, 51, 73, 0.18);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
      background: linear-gradient(180deg, #F6F2F8 0%, #FDFCFE 100%);
      color: var(--text);
      min-height: 100vh;
    }

    .shell { max-width: 1120px; margin: 0 auto; padding: 32px 16px 48px; }

    header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 16px;
      margin-bottom: 24px;
    }

    .brand { display: flex; flex-direction: column; gap: 6px; }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      padding: 5px 12px;
      border-radius: 999px;
      background: rgba(200, 232, 231, 0.2);
      border: 1px solid var(--border-light);
      color: var(--text);
    }

    .pill span.dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: #096E6B;
      box-shadow: none;
    }

    h1 { font-size: 24px; margin: 0; }

    .subtitle {
      font-size: 14px;
      color: rgba(0, 51, 73, 0.75);
      max-width: 520px;
    }

    .header-actions {
      display: flex;
      flex-direction: column;
      gap: 8px;
      align-items: flex-end;
      font-size: 12px;
      color: rgba(0, 51, 73, 0.75);
    }

    .tag-row { display: flex; gap: 6px; flex-wrap: wrap; justify-content: flex-end; }

    .tag {
      border-radius: 999px;
      padding: 5px 12px;
      background: rgba(200, 232, 231, 0.2);
      border: 1px solid var(--border-light);
      color: var(--text);
      font-size: 11px;
    }

    main {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 0.9fr);
      gap: 16px;
    }

    @media (max-width: 880px) {
      main { grid-template-columns: 1fr; }
      header { flex-direction: column; }
      .header-actions { align-items: flex-start; }
    }

    .card {
      background: var(--card);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border-light);
      padding: 24px;
      box-shadow: var(--shadow-soft);
      height: 1000px;
      overflow-y: auto;
    }

    .card-title-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .card-title-row h2 {
      font-size: 18px;
      margin: 0;
      font-weight: 600;
      color: var(--text);
    }

    .card-title-row .hint { font-size: 12px; color: var(--text-muted); }

    .section-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
      margin-bottom: 12px;
      font-weight: 500;
    }

    .inputs-grid { display: grid; grid-template-columns: 1fr; gap: 10px; }

    .row-2 { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 10px; }

    @media (max-width: 640px) { .row-2 { grid-template-columns: 1fr; } }

    .dropzone {
      border-radius: var(--radius-sm);
      border: 1.5px dashed var(--border-medium);
      padding: 20px 16px;
      background: rgba(221, 233, 239, 0.3);
      cursor: pointer;
      display: flex;
      flex-direction: column;
      gap: 6px;
      transition: border-color 0.15s ease, background 0.15s ease, transform 0.08s ease;
      position: relative;
      overflow: hidden;
    }

    .dropzone.dragover {
      border-color: #096E6B;
      background: rgba(200, 232, 231, 0.4);
      transform: translateY(-1px);
    }

    .dropzone label { font-size: 13px; color: var(--text); font-weight: 500; }

    .dropzone span.primary { font-size: 13px; color: rgba(0, 51, 73, 0.75); }

    .dropzone small { font-size: 12px; color: rgba(0, 51, 73, 0.75); }

    .dropzone input[type="file"] { position: absolute; inset: 0; opacity: 0; cursor: pointer; }

    .file-chip {
      margin-top: 6px;
      font-size: 11px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(200, 232, 231, 0.3);
      border: 1px solid var(--border-light);
      color: var(--text);
    }

    .file-chip svg { width: 11px; height: 11px; }

    label.field-label {
      display: block;
      font-size: 13px;
      margin-bottom: 6px;
      color: var(--text);
      font-weight: 500;
    }

    input.text-input, select.text-input, textarea.text-input {
      width: 100%;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border-light);
      background: #FFFFFF;
      color: var(--text);
      padding: 10px 12px;
      font-size: 14px;
      outline: none;
      transition: border-color 0.15s ease, box-shadow 0.15s ease;
    }

    input.text-input:focus, select.text-input:focus, textarea.text-input:focus {
      border-color: #096E6B;
      box-shadow: 0 0 0 3px rgba(9, 110, 107, 0.08);
    }

    textarea.text-input { min-height: 60px; resize: vertical; }

    .options-row {
      display: flex;
      align-items: center;
      gap: 16px;
      margin: 16px 0;
      flex-wrap: wrap;
    }

    .checkbox-group { display: flex; align-items: center; gap: 6px; }

    .checkbox-group input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }

    .checkbox-group label { font-size: 13px; color: var(--text); cursor: pointer; }

    .btn-primary {
      background: linear-gradient(135deg, #096E6B 0%, #064D4B 100%);
      color: white;
      border: none;
      border-radius: var(--radius-sm);
      padding: 14px 20px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      width: 100%;
      transition: transform 0.1s ease, box-shadow 0.15s ease;
      box-shadow: 0 2px 12px rgba(9, 110, 107, 0.25);
    }

    .btn-primary:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 4px 16px rgba(9, 110, 107, 0.3);
    }

    .btn-primary:active:not(:disabled) { transform: translateY(0); }

    .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; }

    .status-bar {
      margin-top: 12px;
      padding: 10px 14px;
      border-radius: var(--radius-sm);
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 8px;
      background: rgba(221, 233, 239, 0.3);
      border: 1px solid var(--border-light);
      color: var(--text);
    }

    .status-bar.running {
      background: rgba(200, 232, 231, 0.3);
      border-color: #096E6B;
      color: #096E6B;
    }

    .status-bar.error {
      background: rgba(123, 86, 155, 0.08);
      border-color: var(--danger);
      color: var(--danger);
    }

    .status-bar svg { width: 16px; height: 16px; flex-shrink: 0; }

    .output-section { display: flex; flex-direction: column; gap: 12px; }

    .output-controls { display: flex; gap: 8px; align-items: center; justify-content: space-between; flex-wrap: wrap; }

    .tabs { display: flex; gap: 4px; flex-wrap: wrap; }

    .tab-button {
      padding: 5px 10px;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border-light);
      background: transparent;
      color: var(--text);
      font-size: 11px;
      cursor: pointer;
      transition: all 0.15s ease;
      white-space: nowrap;
    }

    .tab-button:hover { background: rgba(200, 232, 231, 0.15); }

    .tab-button.active {
      background: rgba(200, 232, 231, 0.3);
      border-color: #096E6B;
      color: #096E6B;
      font-weight: 500;
    }

    .btn-copy {
      padding: 5px 10px;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border-light);
      background: white;
      color: var(--text);
      font-size: 11px;
      cursor: pointer;
      transition: all 0.15s ease;
      white-space: nowrap;
    }

    .btn-copy:hover {
      background: rgba(200, 232, 231, 0.2);
      border-color: #096E6B;
    }

    .btn-copy.copied {
      background: rgba(200, 232, 231, 0.3);
      border-color: #096E6B;
      color: #096E6B;
    }

    .output-area {
      flex: 1;
      background: rgba(221, 233, 239, 0.2);
      border-radius: var(--radius-sm);
      padding: 18px;
      font-size: 14px;
      line-height: 1.7;
      white-space: pre-wrap;
      overflow-y: auto;
      color: var(--text);
      border: 1px solid var(--border-light);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
      resize: vertical;
      min-height: 300px;
    }

    .output-area:focus {
      outline: none;
      border-color: #096E6B;
      box-shadow: 0 0 0 3px rgba(9, 110, 107, 0.08);
    }

    .output-area[readonly] {
      cursor: not-allowed;
      background: rgba(221, 233, 239, 0.15);
    }

    .output-area.empty {
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-muted);
      font-style: italic;
    }

    .toggle-controls { display: flex; gap: 4px; align-items: center; flex-wrap: wrap; }
  </style>
</head>
<body>
  <div class="shell">
    <header>
      <div class="brand">
        <div class="pill">
          <span class="dot"></span>
          <span>Video Script Generator</span>
        </div>
        <h1>Why We Invested</h1>
        <p class="subtitle">
          Upload your Due Diligence and Deck. We'll generate short-form video
          scripts with Claude AI.
        </p>
      </div>
      <div class="header-actions">
        <div class="tag-row">
          <span class="tag">Claude Sonnet 4.5</span>
          <span class="tag">n8n Powered</span>
        </div>
      </div>
    </header>

    <main>
      <!-- ========== LEFT COLUMN: Inputs ========== -->
      <section class="card">
        <div class="card-title-row">
          <h2>Upload Documents</h2>
          <span class="hint">Required</span>
        </div>

        <div class="inputs-grid" style="margin-top: 80px;">
          <div class="dropzone" data-type="dd">
            <label>Due Diligence Report</label>
            <span class="primary">Drag & drop or click to upload</span>
            <small>PDF</small>
            <input type="file" accept=".pdf,.docx" />
            <div class="file-chip" hidden>
              <svg fill="currentColor" viewBox="0 0 20 20">
                <path d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" />
              </svg>
              <span class="file-name"></span>
            </div>
          </div>

          <div class="dropzone" data-type="deck">
            <label>Company Pitch Deck</label>
            <span class="primary">Drag & drop or click to upload</span>
            <small>PDF</small>
            <input type="file" accept=".pdf,.pptx" />
            <div class="file-chip" hidden>
              <svg fill="currentColor" viewBox="0 0 20 20">
                <path d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" />
              </svg>
              <span class="file-name"></span>
            </div>
          </div>
        </div>

        <div class="section-label" style="margin-top: 24px;">
          Portco & Sponsor Info
        </div>

        <div class="inputs-grid">
          <div class="row-2">
            <div>
              <label for="sponsorName" class="field-label">Portco Name</label>
              <input type="text" id="sponsorName" class="text-input" placeholder="e.g., Oura Ring" data-field-name="sponsor_name" />
            </div>

            <div>
              <label for="sponsorTitle" class="field-label">Sponsor Name</label>
              <input type="text" id="sponsorTitle" class="text-input" placeholder="e.g., Laura Rippy" data-field-name="sponsor_title" />
            </div>
          </div>

          <div>
            <label for="fundName" class="field-label">Team</label>
            <input type="text" id="fundName" class="text-input" placeholder="e.g., Gold Team" data-field-name="fund_name" />
          </div>
        </div>

        <div class="section-label" style="margin-top: 20px;">
          Additional Context
        </div>

        <div class="inputs-grid">
          <div>
            <label for="websiteUrl" class="field-label">Company Website (Optional)</label>
            <input type="url" id="websiteUrl" class="text-input" placeholder="e.g., https://example.com" data-field-name="website_url" />
          </div>

          <div>
            <label for="toneNotes" class="field-label">Tone / Style Notes (Optional)</label>
            <textarea id="toneNotes" class="text-input" placeholder="e.g., Conversational, upbeat, founder-friendly" data-field-name="tone_notes"></textarea>
          </div>
        </div>

        <div class="section-label" style="margin-top: 20px;">
          Select What to Generate
        </div>

        <div class="options-row">
          <div class="checkbox-group">
            <input type="checkbox" id="cbCore" checked data-output-type="core" />
            <label for="cbCore">Impacted Investor Video</label>
          </div>
          <div class="checkbox-group">
            <input type="checkbox" id="cbTiktok" checked data-output-type="tiktok" />
            <label for="cbTiktok">Marketing Video (Redacted)</label>
          </div>
          <div class="checkbox-group">
            <input type="checkbox" id="cbProspect" checked data-output-type="prospect" />
            <label for="cbProspect">Marketing Video (Full)</label>
          </div>
          <div class="checkbox-group">
            <input type="checkbox" id="cbSlides" data-output-type="slides" />
            <label for="cbSlides">Slide Deck</label>
          </div>
        </div>

        <button id="generateBtn" class="btn-primary">Generate Scripts</button>

        <div id="statusLine" class="status-bar">
          <svg fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
          </svg>
          <span>Waiting for inputsâ€¦</span>
        </div>
      </section>

      <!-- ========== RIGHT COLUMN: Output ========== -->
      <section class="card output-section">
        <div class="card-title-row">
          <h2>Generated Scripts</h2>
        </div>

        <div class="output-controls">
          <div id="tabsContainer" class="tabs" style="display: none;">
            <button class="tab-button active" data-view="core" data-output-type="core">Impacted Investor Video</button>
            <button class="tab-button" data-view="tiktok" data-output-type="tiktok">Marketing Video (Redacted)</button>
            <button class="tab-button" data-view="prospect" data-output-type="prospect">Marketing Video (Full)</button>
          </div>
          <div id="toggleControls" class="toggle-controls" style="display: none;">
            <button id="lockBtn" class="btn-copy">ðŸ”’ Unlock</button>
            <button id="downloadBtn" class="btn-copy">Download Scripts</button>
            <button id="copyBtn" class="btn-copy">Copy Script</button>
          </div>
        </div>

        <div id="emailControls" class="output-controls" style="display: none; margin-top: 10px;">
          <input type="email" id="emailRecipientRight" class="text-input" placeholder="Enter email to receive scripts" style="flex: 1;" />
          <button id="sendEmailBtn" class="btn-copy" style="white-space: nowrap;">Send Scripts</button>
        </div>

        <textarea id="outputArea" class="output-area empty" readonly>Scripts will appear here after generation.</textarea>
      </section>
    </main>
  </div>

  <script>
    // ==================== CONFIGURATION ====================
    const N8N_WEBHOOK_URL = 'https://catewoolsey.app.n8n.cloud/webhook/video-script-generator';

    // ==================== STATE MANAGEMENT ====================
    const state = {
      files: { dd: null, deck: null },
      jsonOutput: null,
      currentView: "core",
      selectedOutputs: { core: true, tiktok: true, prospect: true, slides: false },
      scripts: { core: '', tiktok: '', prospect: '' },
      locked: { core: true, tiktok: true, prospect: true }
    };

    // ==================== DOM REFERENCES ====================
    const statusLine = document.getElementById("statusLine");
    const generateBtn = document.getElementById("generateBtn");
    const outputArea = document.getElementById("outputArea");
    const tabsContainer = document.getElementById("tabsContainer");
    const toggleControls = document.getElementById("toggleControls");
    const emailControls = document.getElementById("emailControls");
    const lockBtn = document.getElementById("lockBtn");
    const downloadBtn = document.getElementById("downloadBtn");
    const copyBtn = document.getElementById("copyBtn");
    const sendEmailBtn = document.getElementById("sendEmailBtn");

    // ==================== HELPER FUNCTIONS ====================
    function setStatus(message, mode = "idle") {
      statusLine.classList.remove("running", "error");
      if (mode === "running") statusLine.classList.add("running");
      if (mode === "error") statusLine.classList.add("error");
      statusLine.querySelector("span:nth-child(2)").textContent = message;
    }

    function getFieldName(element) {
      return element.getAttribute('data-field-name') || element.id;
    }

    // ==================== FILE UPLOAD HANDLING ====================
    document.querySelectorAll(".dropzone").forEach((zone) => {
      const input = zone.querySelector('input[type="file"]');
      const chip = zone.querySelector(".file-chip");
      const fileNameSpan = chip.querySelector(".file-name");

      function setFile(file) {
        if (!file) return;
        const type = zone.getAttribute("data-type");
        state.files[type] = file;
        fileNameSpan.textContent = file.name;
        chip.hidden = false;
      }

      zone.addEventListener("dragover", (e) => { e.preventDefault(); zone.classList.add("dragover"); });
      zone.addEventListener("dragleave", () => { zone.classList.remove("dragover"); });
      zone.addEventListener("drop", (e) => {
        e.preventDefault();
        zone.classList.remove("dragover");
        const file = e.dataTransfer.files[0];
        if (file) setFile(file);
      });

      input.addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (file) setFile(file);
      });
    });

    // ==================== CHECKBOX TRACKING ====================
    document.querySelectorAll('input[type="checkbox"][data-output-type]').forEach(checkbox => {
      const outputType = checkbox.getAttribute('data-output-type');
      state.selectedOutputs[outputType] = checkbox.checked;

      checkbox.addEventListener("change", (e) => {
        const outputType = e.target.getAttribute('data-output-type');
        state.selectedOutputs[outputType] = e.target.checked;
        console.log('Checkbox changed:', outputType, e.target.checked); // DEBUG
      });
    });

    // ==================== TAB SWITCHING ====================
    document.querySelectorAll(".tab-button").forEach((btn) => {
      btn.addEventListener("click", () => {
        if (!state.locked[state.currentView]) {
          state.scripts[state.currentView] = outputArea.value;
        }

        document.querySelectorAll(".tab-button").forEach((b) => b.classList.remove("active"));
        btn.classList.add("active");
        state.currentView = btn.getAttribute("data-view");
        updateOutputView();
      });
    });

    // ==================== LOCK/UNLOCK FUNCTIONALITY ====================
    lockBtn.addEventListener("click", () => {
      state.locked[state.currentView] = !state.locked[state.currentView];
      updateLockState();
    });

    function updateLockState() {
      const isLocked = state.locked[state.currentView];
      if (isLocked) {
        outputArea.setAttribute('readonly', 'readonly');
        lockBtn.textContent = 'ðŸ”’ Unlock';
      } else {
        outputArea.removeAttribute('readonly');
        lockBtn.textContent = 'ðŸ”“ Lock';
      }
    }

    // ==================== EDIT TRACKING ====================
    outputArea.addEventListener("input", () => {
      if (!state.locked[state.currentView]) {
        state.scripts[state.currentView] = outputArea.value;
      }
    });

    // ==================== DOWNLOAD FUNCTIONALITY ====================
    downloadBtn.addEventListener("click", () => {
      if (!state.jsonOutput || !state.scripts.core && !state.scripts.tiktok && !state.scripts.prospect) {
        return;
      }

      let fileContent = '';
      const sponsorName = document.getElementById("sponsorName").value.trim();
      const fundName = document.getElementById("fundName").value.trim();
      
      // Add header
      fileContent += `Video Scripts - ${sponsorName || 'Portco'} - ${fundName || 'Team'}\n`;
      fileContent += `Generated: ${new Date().toLocaleString()}\n`;
      fileContent += `${'='.repeat(80)}\n\n`;

      // Add each script with clear separators
      if (state.scripts.core) {
        fileContent += `IMPACTED INVESTOR VIDEO\n`;
        fileContent += `${'-'.repeat(80)}\n\n`;
        fileContent += state.scripts.core;
        fileContent += `\n\n${'='.repeat(80)}\n\n`;
      }

      if (state.scripts.tiktok) {
        fileContent += `MARKETING VIDEO (REDACTED)\n`;
        fileContent += `${'-'.repeat(80)}\n\n`;
        fileContent += state.scripts.tiktok;
        fileContent += `\n\n${'='.repeat(80)}\n\n`;
      }

      if (state.scripts.prospect) {
        fileContent += `MARKETING VIDEO (FULL)\n`;
        fileContent += `${'-'.repeat(80)}\n\n`;
        fileContent += state.scripts.prospect;
        fileContent += `\n\n${'='.repeat(80)}\n`;
      }

      // Create and download file
      const blob = new Blob([fileContent], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `video-scripts-${Date.now()}.txt`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      // Visual feedback
      const originalText = downloadBtn.textContent;
      downloadBtn.textContent = "âœ“ Downloaded!";
      downloadBtn.classList.add("copied");
      setTimeout(() => {
        downloadBtn.textContent = originalText;
        downloadBtn.classList.remove("copied");
      }, 2000);
    });

    // ==================== COPY FUNCTIONALITY ====================
    copyBtn.addEventListener("click", async () => {
      const textToCopy = outputArea.value;

      if (!textToCopy || textToCopy === "Scripts will appear here after generation.") {
        return;
      }

      try {
        await navigator.clipboard.writeText(textToCopy);

        const originalText = copyBtn.textContent;
        copyBtn.textContent = "âœ“ Copied!";
        copyBtn.classList.add("copied");

        setTimeout(() => {
          copyBtn.textContent = originalText;
          copyBtn.classList.remove("copied");
        }, 2000);

      } catch (error) {
        console.error('Failed to copy:', error);
        copyBtn.textContent = "Copy Failed";
        setTimeout(() => {
          copyBtn.textContent = "Copy Script";
        }, 2000);
      }
    });

    // ==================== EMAIL SENDING FUNCTIONALITY ====================
    sendEmailBtn.addEventListener("click", async () => {
      const emailRecipient = document.getElementById("emailRecipientRight").value.trim();

      console.log("ðŸ” Send button clicked");
      console.log("ðŸ“§ Email recipient:", emailRecipient);
      console.log("ðŸ“„ Current scripts state:", state.scripts);

      if (!emailRecipient) {
        alert("Please enter an email address");
        return;
      }

      if (!state.jsonOutput) {
        alert("No scripts to send. Generate scripts first.");
        return;
      }

      sendEmailBtn.disabled = true;
      const originalText = sendEmailBtn.textContent;
      sendEmailBtn.textContent = "Sending...";

      try {
        const emailPayload = {
          recipient: emailRecipient,
          scripts: {
            core: state.scripts.core || state.jsonOutput?.scripts?.core || '',
            tiktok: state.scripts.tiktok || state.jsonOutput?.scripts?.tiktok || '',
            prospect: state.scripts.prospect || state.jsonOutput?.scripts?.prospect_safe || ''
          },
          metadata: {
            sponsorName: document.getElementById("sponsorName").value,
            sponsorTitle: document.getElementById("sponsorTitle").value,
            fundName: document.getElementById("fundName").value
          }
        };

        console.log("ðŸ“¦ Email payload:", emailPayload);
        console.log("ðŸŒ Sending to webhook: https://catewoolsey.app.n8n.cloud/webhook/send-scripts-email");

        const response = await fetch('https://catewoolsey.app.n8n.cloud/webhook/send-scripts-email', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(emailPayload)
        });

        console.log("ðŸ“¡ Response status:", response.status);
        console.log("ðŸ“¡ Response ok:", response.ok);

        const responseData = await response.text();
        console.log("ðŸ“¡ Response body:", responseData);

        if (response.ok) {
          sendEmailBtn.textContent = "âœ“ Sent!";
          setTimeout(() => {
            sendEmailBtn.textContent = originalText;
            sendEmailBtn.disabled = false;
          }, 2000);
        } else {
          alert(`Email send failed: ${response.status} - ${responseData}`);
          sendEmailBtn.textContent = "Failed";
          setTimeout(() => {
            sendEmailBtn.textContent = originalText;
            sendEmailBtn.disabled = false;
          }, 2000);
        }
      } catch (error) {
        console.error('âŒ Email error:', error);
        alert(`Error sending email: ${error.message}`);
        sendEmailBtn.textContent = "Failed";
        setTimeout(() => {
          sendEmailBtn.textContent = originalText;
          sendEmailBtn.disabled = false;
        }, 2000);
      }
    });

    // ==================== OUTPUT VIEW UPDATE ====================
    function updateOutputView() {
      if (!state.jsonOutput) {
        outputArea.classList.add("empty");
        outputArea.value = "Scripts will appear here after generation.";
        outputArea.setAttribute('readonly', 'readonly');
        tabsContainer.style.display = "none";
        toggleControls.style.display = "none";
        emailControls.style.display = "none";
        return;
      }

      outputArea.classList.remove("empty");
      tabsContainer.style.display = "flex";
      toggleControls.style.display = "flex";
      emailControls.style.display = "flex";

      document.querySelectorAll('.tab-button').forEach(btn => {
        const viewType = btn.getAttribute('data-view');
        const outputType = btn.getAttribute('data-output-type');

        if (outputType && state.selectedOutputs[outputType]) {
          btn.style.display = 'block';
        } else {
          btn.style.display = 'none';

          if (state.currentView === viewType) {
            const firstVisible = Array.from(document.querySelectorAll('.tab-button'))
              .find(b => b.style.display !== 'none');
            if (firstVisible) {
              firstVisible.click();
              return;
            }
          }
        }
      });

      renderViewContent(state.currentView);
      updateLockState();
    }

    function renderViewContent(view) {
      const scripts = state.jsonOutput.scripts || {};
      let content = '';

      if (state.scripts[view]) {
        content = state.scripts[view];
      } else if (view === "core" && scripts.core) {
        content = scripts.core;
        state.scripts.core = content;
      } else if (view === "tiktok" && scripts.tiktok) {
        content = scripts.tiktok;
        state.scripts.tiktok = content;
      } else if (view === "prospect" && scripts.prospect_safe) {
        content = scripts.prospect_safe;
        state.scripts.prospect = content;
      } else {
        content = `No content available for ${view}.`;
      }

      outputArea.value = content;
    }

    // ==================== FORM VALIDATION ====================
    function validateForm() {
      const errors = [];

      if (!state.files.dd) {
        errors.push("Due Diligence Report is required");
      }

      // Deck is optional (no validation)

      const sponsorName = document.getElementById("sponsorName").value.trim();
      const fundName = document.getElementById("fundName").value.trim();

      if (!sponsorName) errors.push("Portco Name is required");
      if (!fundName) errors.push("Team is required");

      const hasSelection = state.selectedOutputs.core ||
                          state.selectedOutputs.tiktok ||
                          state.selectedOutputs.prospect;

      if (!hasSelection) {
        errors.push("Please select at least one script type to generate");
      }

      return errors;
    }

    // ==================== MAIN GENERATION FUNCTION ====================
    generateBtn.addEventListener("click", async () => {
      const errors = validateForm();
      if (errors.length > 0) {
        setStatus(errors[0], "error");
        return;
      }

      const sponsorName = document.getElementById("sponsorName").value.trim();
      const sponsorTitle = document.getElementById("sponsorTitle").value.trim();
      const fundName = document.getElementById("fundName").value.trim();
      const websiteUrl = document.getElementById("websiteUrl").value.trim();
      const toneNotes = document.getElementById("toneNotes").value.trim();

      setStatus("Uploading files and generating scripts with Claude AIâ€¦", "running");
      generateBtn.disabled = true;

      try {
        const formData = new FormData();

        formData.append('dd_report', state.files.dd);

        // Deck is optional: only append if a file exists
        if (state.files.deck) {
          formData.append('company_deck', state.files.deck);
        }

        formData.append('sponsor_name', sponsorName);
        formData.append('sponsor_title', sponsorTitle);
        formData.append('fund_name', fundName);
        formData.append('website_url', websiteUrl);
        formData.append('tone_notes', toneNotes);
        formData.append('generate_core', state.selectedOutputs.core ? 'true' : 'false');
        formData.append('generate_tiktok', state.selectedOutputs.tiktok ? 'true' : 'false');
        formData.append('generate_prospect', state.selectedOutputs.prospect ? 'true' : 'false');
        formData.append('generate_slides', state.selectedOutputs.slides ? 'true' : 'false');

        const response = await fetch(N8N_WEBHOOK_URL, {
          method: 'POST',
          body: formData
        });

        if (!response.ok) {
          let errorMessage = `HTTP ${response.status}: ${response.statusText}`;
          try {
            const errorData = await response.json();
            if (errorData.error) {
              errorMessage = errorData.error;
            }
          } catch (e) {}
          throw new Error(errorMessage);
        }

        const result = await response.json();

        console.log('Response from server:', result); // DEBUG

        if (!result || typeof result !== 'object') {
          throw new Error('Invalid response format from server');
        }

        state.jsonOutput = result;
        console.log('State jsonOutput:', state.jsonOutput); // DEBUG
        console.log('Scripts object:', state.jsonOutput.scripts); // DEBUG

        if (result.scripts) {
          state.scripts.core = result.scripts.core || '';
          state.scripts.tiktok = result.scripts.tiktok || '';
          state.scripts.prospect = result.scripts.prospect_safe || '';

          if (result.scripts.core) state.locked.core = false;
          if (result.scripts.tiktok) state.locked.tiktok = false;
          if (result.scripts.prospect_safe) state.locked.prospect = false;
        }

        updateOutputView();
        setStatus("âœ“ Scripts generated successfully!", "idle");

      } catch (error) {
        console.error('Generation error:', error);
        setStatus(`Error: ${error.message}`, "error");
      } finally {
        generateBtn.disabled = false;
      }
    });

    // ==================== INITIALIZATION ====================
    setStatus("Waiting for inputsâ€¦", "idle");
  </script>
</body>
</html>
