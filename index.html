<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Why We Invested – Video Generator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #F6F2F8;
      --card: #FFFFFF;
      --accent: #C8E8E7;
      --accent-soft: rgba(200, 232, 231, 0.3);
      --border-light: rgba(0, 51, 73, 0.55);
      --border-medium: rgba(0, 51, 73, 0.55);
      --text: #003349;
      --text-muted: rgba(0, 51, 73, 0.6);
      --danger: #7B569B;
      --radius-lg: 18px;
      --radius-sm: 10px;
      --shadow-soft: 0 4px 20px rgba(0, 51, 73, 0.18);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        sans-serif;
      background: linear-gradient(180deg, #F6F2F8 0%, #FDFCFE 100%);
      color: var(--text);
      min-height: 100vh;
    }

    .shell {
      max-width: 1120px;
      margin: 0 auto;
      padding: 32px 16px 48px;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 16px;
      margin-bottom: 24px;
    }

    .brand {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      padding: 5px 12px;
      border-radius: 999px;
      background: rgba(200, 232, 231, 0.2);
      border: 1px solid var(--border-light);
      color: var(--text);
    }

    .pill span.dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: #096E6B;
      box-shadow: none;
    }

    h1 {
      font-size: 24px;
      margin: 0;
    }

    .subtitle {
      font-size: 14px;
      color: rgba(0, 51, 73, 0.75);
      max-width: 520px;
    }

    .header-actions {
      display: flex;
      flex-direction: column;
      gap: 8px;
      align-items: flex-end;
      font-size: 12px;
      color: rgba(0, 51, 73, 0.75);
    }

    .tag-row {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .tag {
      border-radius: 999px;
      padding: 5px 12px;
      background: rgba(200, 232, 231, 0.2);
      border: 1px solid var(--border-light);
      color: var(--text);
      font-size: 11px;
    }

    main {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 0.9fr);
      gap: 16px;
    }

    @media (max-width: 880px) {
      main {
        grid-template-columns: 1fr;
      }
      header {
        flex-direction: column;
      }
      .header-actions {
        align-items: flex-start;
      }
    }

    .card {
      background: var(--card);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border-light);
      padding: 24px;
      box-shadow: var(--shadow-soft);
    }

    .card-title-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .card-title-row h2 {
      font-size: 18px;
      margin: 0;
      font-weight: 600;
      color: var(--text);
    }

    .card-title-row .hint {
      font-size: 12px;
      color: var(--text-muted);
    }

    .section-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
      margin-bottom: 12px;
      font-weight: 500;
    }

    .inputs-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }

    .row-2 {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
    }

    @media (max-width: 640px) {
      .row-2 {
        grid-template-columns: 1fr;
      }
    }

    .dropzone {
      border-radius: var(--radius-sm);
      border: 1.5px dashed var(--border-medium);
      padding: 20px 16px;
      background: rgba(221, 233, 239, 0.3);
      cursor: pointer;
      display: flex;
      flex-direction: column;
      gap: 6px;
      transition: border-color 0.15s ease, background 0.15s ease,
        transform 0.08s ease;
      position: relative;
      overflow: hidden;
    }

    .dropzone.dragover {
      border-color: #096E6B;
      background: rgba(200, 232, 231, 0.4);
      transform: translateY(-1px);
    }

    .dropzone label {
      font-size: 13px;
      color: var(--text);
      font-weight: 500;
    }

    .dropzone span.primary {
      font-size: 13px;
      color: rgba(0, 51, 73, 0.75);
    }

    .dropzone small {
      font-size: 12px;
      color: rgba(0, 51, 73, 0.75);
    }

    .dropzone input[type="file"] {
      position: absolute;
      inset: 0;
      opacity: 0;
      cursor: pointer;
    }

    .file-chip {
      margin-top: 6px;
      font-size: 11px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(200, 232, 231, 0.3);
      border: 1px solid var(--border-light);
      color: var(--text);
    }

    .file-chip svg {
      width: 11px;
      height: 11px;
    }

    label.field-label {
      display: block;
      font-size: 13px;
      margin-bottom: 6px;
      color: var(--text);
      font-weight: 500;
    }

    input.text-input, select.text-input, textarea.text-input {
      width: 100%;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border-light);
      background: #FFFFFF;
      color: var(--text);
      padding: 10px 12px;
      font-size: 14px;
      outline: none;
      transition: border-color 0.15s ease, box-shadow 0.15s ease;
    }

    input.text-input:focus,
    select.text-input:focus,
    textarea.text-input:focus {
      border-color: #096E6B;
      box-shadow: 0 0 0 3px rgba(9, 110, 107, 0.08);
    }

    textarea.text-input {
      min-height: 60px;
      resize: vertical;
    }

    .options-row {
      display: flex;
      align-items: center;
      gap: 16px;
      margin: 16px 0;
      flex-wrap: wrap;
    }

    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .checkbox-group input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
      accent-color: #096E6B;
    }

    .checkbox-group label {
      font-size: 14px;
      cursor: pointer;
      color: var(--text);
    }

    .primary-button {
      background: #096E6B;
      color: #FFFFFF;
      border: none;
      border-radius: var(--radius-sm);
      padding: 11px 20px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.15s ease, transform 0.08s ease;
      white-space: nowrap;
    }

    .primary-button:hover:not(:disabled) {
      background: #075956;
    }

    .primary-button:active:not(:disabled) {
      transform: translateY(1px);
    }

    .primary-button:disabled {
      background: rgba(9, 110, 107, 0.4);
      cursor: not-allowed;
    }

    .secondary-button {
      background: rgba(200, 232, 231, 0.3);
      border: 1px solid var(--border-light);
      color: var(--text);
      border-radius: var(--radius-sm);
      padding: 8px 14px;
      font-size: 13px;
      cursor: pointer;
      transition: background 0.15s ease;
    }

    .secondary-button:hover {
      background: rgba(200, 232, 231, 0.5);
    }

    .status-container {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid rgba(0, 51, 73, 0.1);
    }

    .status-line {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: var(--text-muted);
    }

    .status-line .bullet {
      font-size: 12px;
      color: rgba(0, 51, 73, 0.3);
    }

    .status-line.running .bullet {
      color: #096E6B;
      animation: pulse 1.5s ease-in-out infinite;
    }

    .status-line.error .bullet {
      color: var(--danger);
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }

    .toggle-controls {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }

    .tabs {
      display: flex;
      gap: 4px;
      margin-bottom: 12px;
      border-bottom: 1px solid rgba(0, 51, 73, 0.1);
      padding-bottom: 4px;
    }

    .tab-button {
      background: transparent;
      border: none;
      color: var(--text-muted);
      padding: 8px 14px;
      font-size: 13px;
      cursor: pointer;
      border-radius: 6px;
      transition: background 0.15s ease, color 0.15s ease;
    }

    .tab-button:hover {
      background: rgba(200, 232, 231, 0.2);
      color: var(--text);
    }

    .tab-button.active {
      background: rgba(200, 232, 231, 0.3);
      color: var(--text);
      font-weight: 500;
    }

    .output-area {
      background: rgba(221, 233, 239, 0.15);
      border-radius: var(--radius-sm);
      padding: 16px;
      min-height: 180px;
      font-size: 14px;
      line-height: 1.6;
      white-space: pre-wrap;
      word-wrap: break-word;
      overflow-y: auto;
      max-height: 600px;
    }

    .output-area.empty {
      color: var(--text-muted);
      display: flex;
      align-items: center;
      justify-content: center;
      font-style: italic;
    }

    /* NEW: Section headers for better output organization */
    .output-section-header {
      font-size: 15px;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 8px;
      padding-bottom: 4px;
      border-bottom: 1px solid rgba(0, 51, 73, 0.1);
    }
  </style>
</head>
<body>
  <div class="shell">
    <header>
      <div class="brand">
        <div>
          <span class="pill">
            <span class="dot"></span>
            Video Generator
          </span>
        </div>
        <h1>Why We Invested</h1>
        <p class="subtitle">
          Upload your due diligence report and pitch deck to generate
          professional video scripts powered by Claude AI
        </p>
      </div>

      <div class="header-actions">
        <div class="tag-row">
          <span class="tag">Claude 3.5 Sonnet</span>
          <span class="tag">n8n Powered</span>
        </div>
      </div>
    </header>

    <main>
      <!-- LEFT: Inputs -->
      <section class="card">
        <div class="section-label">Inputs</div>
        <div class="card-title-row">
          <h2>Required Files</h2>
          <span class="hint">2 files needed</span>
        </div>

        <div class="inputs-grid">
          <!-- Due Diligence Report -->
          <div class="dropzone" data-type="dd" data-field-name="dd_report">
            <label>Due Diligence Report</label>
            <span class="primary">Drag file here or click to browse</span>
            <small>PDF preferred</small>
            <input type="file" accept=".pdf,.doc,.docx" />
            <span class="file-chip" hidden>
              <svg fill="currentColor" viewBox="0 0 20 20">
                <path d="M9 2a2 2 0 00-2 2v8a2 2 0 002 2h6a2 2 0 002-2V6.414A2 2 0 0016.414 5L13 1.586A2 2 0 0011.586 1H9z" />
              </svg>
              <span class="file-name"></span>
            </span>
          </div>

          <!-- Company Deck -->
          <div class="dropzone" data-type="deck" data-field-name="company_deck">
            <label>Company Pitch Deck</label>
            <span class="primary">Drag file here or click to browse</span>
            <small>PDF or PPT</small>
            <input type="file" accept=".pdf,.ppt,.pptx" />
            <span class="file-chip" hidden>
              <svg fill="currentColor" viewBox="0 0 20 20">
                <path d="M9 2a2 2 0 00-2 2v8a2 2 0 002 2h6a2 2 0 002-2V6.414A2 2 0 0016.414 5L13 1.586A2 2 0 0011.586 1H9z" />
              </svg>
              <span class="file-name"></span>
            </span>
          </div>
        </div>

        <div class="card-title-row" style="margin-top: 24px;">
          <h2>Script Details</h2>
        </div>

        <div class="inputs-grid">
          <div class="row-2">
            <div>
              <label class="field-label" for="sponsorName">Sponsor Name *</label>
              <input
                type="text"
                id="sponsorName"
                class="text-input"
                placeholder="e.g., Drew Collins"
                data-field-name="sponsor_name"
              />
            </div>
            <div>
              <label class="field-label" for="sponsorTitle">Sponsor Title</label>
              <input
                type="text"
                id="sponsorTitle"
                class="text-input"
                placeholder="e.g., Managing Partner"
                data-field-name="sponsor_title"
              />
            </div>
          </div>

          <div class="row-2">
            <div>
              <label class="field-label" for="fundName">Fund Name *</label>
              <input
                type="text"
                id="fundName"
                class="text-input"
                placeholder="e.g., Alumni Ventures"
                data-field-name="fund_name"
              />
            </div>
            <div>
              <label class="field-label" for="websiteUrl">Company Website</label>
              <input
                type="url"
                id="websiteUrl"
                class="text-input"
                placeholder="https://company.com"
                data-field-name="website_url"
              />
            </div>
          </div>

          <div>
            <label class="field-label" for="toneNotes">Tone & Style Notes</label>
            <textarea
              id="toneNotes"
              class="text-input"
              placeholder="e.g., Keep it conversational, emphasize the team's technical expertise..."
              data-field-name="tone_notes"
            ></textarea>
          </div>
        </div>

        <div class="card-title-row" style="margin-top: 24px;">
          <h2>Output Selection</h2>
        </div>

        <div class="options-row">
          <div class="checkbox-group">
            <input type="checkbox" id="wantCore" checked data-output-type="core" />
            <label for="wantCore">Core Script</label>
          </div>
          <div class="checkbox-group">
            <input type="checkbox" id="wantTiktok" checked data-output-type="tiktok" />
            <label for="wantTiktok">TikTok Script</label>
          </div>
          <div class="checkbox-group">
            <input type="checkbox" id="wantProspect" checked data-output-type="prospect" />
            <label for="wantProspect">Prospect-Safe</label>
          </div>
        </div>

        <button class="primary-button" id="generateBtn">
          Generate Scripts with AI
        </button>

        <div class="status-container">
          <div class="status-line" id="statusLine">
            <span class="bullet">●</span>
            <span>Waiting for inputs…</span>
          </div>
        </div>
      </section>

      <!-- RIGHT: Outputs -->
      <section class="card">
        <div class="section-label">Outputs</div>
        <div class="card-title-row">
          <h2>Generated Scripts</h2>
        </div>

        <div class="toggle-controls" id="toggleControls" style="display: none;">
          <button class="secondary-button" id="toggleJsonBtn">Show JSON</button>
          <button class="secondary-button download-button" id="downloadBtn">Download All</button>
        </div>

        <div class="tabs" id="tabsContainer" style="display: none;">
          <!-- NEW: data-output-type matches checkbox values for easier management -->
          <button class="tab-button active" data-view="core" data-output-type="core">Core Script</button>
          <button class="tab-button" data-view="tiktok" data-output-type="tiktok">TikTok Script</button>
          <button class="tab-button" data-view="prospect" data-output-type="prospect">Prospect-Safe</button>
          <button class="tab-button" data-view="storyboard">Storyboard</button>
        </div>

        <div id="outputArea" class="output-area empty">
          Scripts will appear here after generation.
        </div>
      </section>
    </main>
  </div>

  <script>
    // ==================== CONFIGURATION ====================
    const N8N_WEBHOOK_URL = 'https://drewav.app.n8n.cloud/webhook/video-script-generator';
    
    // ==================== STATE MANAGEMENT ====================
    const state = {
      files: {
        dd: null,
        deck: null
      },
      jsonOutput: null,
      currentView: "core",
      showJson: false,
      selectedOutputs: {
        core: true,
        tiktok: true,
        prospect: true
      }
    };

    // ==================== DOM REFERENCES ====================
    const statusLine = document.getElementById("statusLine");
    const generateBtn = document.getElementById("generateBtn");
    const outputArea = document.getElementById("outputArea");
    const tabsContainer = document.getElementById("tabsContainer");
    const toggleControls = document.getElementById("toggleControls");

    // ==================== HELPER FUNCTIONS ====================
    
    /**
     * Update status line with message and visual state
     */
    function setStatus(message, mode = "idle") {
      statusLine.classList.remove("running", "error");
      if (mode === "running") statusLine.classList.add("running");
      if (mode === "error") statusLine.classList.add("error");
      statusLine.querySelector("span:nth-child(2)").textContent = message;
    }

    /**
     * Get field name from element's data attribute
     */
    function getFieldName(element) {
      return element.getAttribute('data-field-name') || element.id;
    }

    // ==================== FILE UPLOAD HANDLING ====================
    
    document.querySelectorAll(".dropzone").forEach((zone) => {
      const input = zone.querySelector('input[type="file"]');
      const chip = zone.querySelector(".file-chip");
      const fileNameSpan = chip.querySelector(".file-name");

      function setFile(file) {
        if (!file) return;
        const type = zone.getAttribute("data-type");
        state.files[type] = file;
        fileNameSpan.textContent = file.name;
        chip.hidden = false;
      }

      zone.addEventListener("dragover", (e) => {
        e.preventDefault();
        zone.classList.add("dragover");
      });
      
      zone.addEventListener("dragleave", () => {
        zone.classList.remove("dragover");
      });
      
      zone.addEventListener("drop", (e) => {
        e.preventDefault();
        zone.classList.remove("dragover");
        const file = e.dataTransfer.files[0];
        if (file) setFile(file);
      });
      
      input.addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (file) setFile(file);
      });
    });

    // ==================== CHECKBOX TRACKING ====================
    
    // Use data attributes for more maintainable code
    document.querySelectorAll('input[type="checkbox"][data-output-type]').forEach(checkbox => {
      checkbox.addEventListener("change", (e) => {
        const outputType = e.target.getAttribute('data-output-type');
        state.selectedOutputs[outputType] = e.target.checked;
      });
    });

    // ==================== TAB SWITCHING ====================
    
    document.querySelectorAll(".tab-button").forEach((btn) => {
      btn.addEventListener("click", () => {
        document.querySelectorAll(".tab-button").forEach((b) => b.classList.remove("active"));
        btn.classList.add("active");
        state.currentView = btn.getAttribute("data-view");
        updateOutputView();
      });
    });

    // ==================== JSON VIEW TOGGLE ====================
    
    document.getElementById("toggleJsonBtn").addEventListener("click", () => {
      state.showJson = !state.showJson;
      updateOutputView();
      document.getElementById("toggleJsonBtn").textContent = state.showJson
        ? "Hide JSON"
        : "Show JSON";
    });

    // ==================== DOWNLOAD FUNCTIONALITY ====================
    
    document.getElementById("downloadBtn").addEventListener("click", () => {
      if (!state.jsonOutput) return;
      
      const blob = new Blob([JSON.stringify(state.jsonOutput, null, 2)], {
        type: 'application/json'
      });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      
      // Include timestamp in filename for uniqueness
      const timestamp = new Date().toISOString().split('T')[0];
      a.download = `video-scripts-${timestamp}.json`;
      
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });

    // ==================== OUTPUT VIEW UPDATE ====================
    
    /**
     * Update the output area based on current state and selected view
     */
    function updateOutputView() {
      if (!state.jsonOutput) {
        outputArea.classList.add("empty");
        outputArea.textContent = "Scripts will appear here after generation.";
        tabsContainer.style.display = "none";
        toggleControls.style.display = "none";
        return;
      }

      outputArea.classList.remove("empty");
      tabsContainer.style.display = "flex";
      toggleControls.style.display = "flex";

      // Show JSON view if toggled
      if (state.showJson) {
        outputArea.textContent = JSON.stringify(state.jsonOutput, null, 2);
        return;
      }

      // Manage tab visibility based on what was generated
      document.querySelectorAll('.tab-button').forEach(btn => {
        const viewType = btn.getAttribute('data-view');
        const outputType = btn.getAttribute('data-output-type');
        
        // Storyboard is always shown
        if (viewType === 'storyboard') {
          btn.style.display = 'block';
        } 
        // Other tabs only show if they were selected AND generated
        else if (outputType && state.selectedOutputs[outputType]) {
          btn.style.display = 'block';
        } else {
          btn.style.display = 'none';
          
          // If currently viewing a hidden tab, switch to first visible
          if (state.currentView === viewType) {
            const firstVisible = Array.from(document.querySelectorAll('.tab-button'))
              .find(b => b.style.display !== 'none');
            if (firstVisible) {
              firstVisible.click();
              return; // Exit early, click will re-trigger this function
            }
          }
        }
      });

      // Render selected view content
      renderViewContent(state.currentView);
    }

    /**
     * Render content for specific view type
     */
    function renderViewContent(view) {
      const scripts = state.jsonOutput.scripts || {};
      const storyboard = state.jsonOutput.storyboard || [];

      let content = '';

      if (view === "core" && scripts.core) {
        content = scripts.core;
      } else if (view === "tiktok" && scripts.tiktok) {
        content = scripts.tiktok;
      } else if (view === "prospect" && scripts.prospect_safe) {
        content = scripts.prospect_safe;
      } else if (view === "storyboard" && storyboard.length > 0) {
        content = formatStoryboard(storyboard);
      } else {
        content = `No content available for ${view}.`;
      }

      outputArea.textContent = content;
    }

    /**
     * Format storyboard array into readable text
     */
    function formatStoryboard(storyboard) {
      const lines = storyboard.map((seg) => {
        return (
          `Segment ${seg.segment_id} (${seg.approx_start_seconds}s–${seg.approx_end_seconds}s)\n` +
          `VO: ${seg.voiceover_text}\n` +
          `On-screen: ${seg.on_screen_text}\n` +
          `B-roll: ${seg.b_roll_suggestions.join(", ")}\n`
        );
      });
      return lines.join("\n----------------------\n\n");
    }

    // ==================== FORM VALIDATION ====================
    
    /**
     * Validate all required fields before submission
     */
    function validateForm() {
      const errors = [];

      // Check files
      if (!state.files.dd) {
        errors.push("Due Diligence Report is required");
      }
      if (!state.files.deck) {
        errors.push("Company Pitch Deck is required");
      }

      // Check required text fields
      const sponsorName = document.getElementById("sponsorName").value.trim();
      const fundName = document.getElementById("fundName").value.trim();

      if (!sponsorName) {
        errors.push("Sponsor Name is required");
      }
      if (!fundName) {
        errors.push("Fund Name is required");
      }

      // Check at least one output selected
      const hasSelection = state.selectedOutputs.core || 
                          state.selectedOutputs.tiktok || 
                          state.selectedOutputs.prospect;
      
      if (!hasSelection) {
        errors.push("Please select at least one script type to generate");
      }

      return errors;
    }

    // ==================== MAIN GENERATION FUNCTION ====================
    
    generateBtn.addEventListener("click", async () => {
      // Validate form
      const errors = validateForm();
      if (errors.length > 0) {
        setStatus(errors[0], "error");
        return;
      }

      // Gather all form data
      const sponsorName = document.getElementById("sponsorName").value.trim();
      const sponsorTitle = document.getElementById("sponsorTitle").value.trim();
      const fundName = document.getElementById("fundName").value.trim();
      const websiteUrl = document.getElementById("websiteUrl").value.trim();
      const toneNotes = document.getElementById("toneNotes").value.trim();

      setStatus("Uploading files and generating scripts with Claude AI…", "running");
      generateBtn.disabled = true;

      try {
        // Prepare FormData for file upload
        const formData = new FormData();
        
        // Add files
        formData.append('dd_report', state.files.dd);
        formData.append('company_deck', state.files.deck);
        
        // Add text fields
        formData.append('sponsor_name', sponsorName);
        formData.append('sponsor_title', sponsorTitle);
        formData.append('fund_name', fundName);
        formData.append('website_url', websiteUrl);
        formData.append('tone_notes', toneNotes);
        
        // CRITICAL: Convert booleans to strings "true"/"false" for n8n
        // n8n will interpret these correctly in IF nodes
        formData.append('generate_core', state.selectedOutputs.core ? 'true' : 'false');
        formData.append('generate_tiktok', state.selectedOutputs.tiktok ? 'true' : 'false');
        formData.append('generate_prospect', state.selectedOutputs.prospect ? 'true' : 'false');

        // Send to n8n webhook
        const response = await fetch(N8N_WEBHOOK_URL, {
          method: 'POST',
          body: formData
        });

        if (!response.ok) {
          // Try to get error message from response body
          let errorMessage = `HTTP ${response.status}: ${response.statusText}`;
          try {
            const errorData = await response.json();
            if (errorData.error) {
              errorMessage = errorData.error;
            }
          } catch (e) {
            // If response isn't JSON, use status text
          }
          throw new Error(errorMessage);
        }

        const result = await response.json();
        
        // Validate response structure
        if (!result || typeof result !== 'object') {
          throw new Error('Invalid response format from server');
        }

        // Store the full response
        state.jsonOutput = result;
        
        // Update UI
        updateOutputView();
        setStatus("✓ Scripts generated successfully!", "idle");
        
      } catch (error) {
        console.error('Generation error:', error);
        setStatus(`Error: ${error.message}`, "error");
      } finally {
        generateBtn.disabled = false;
      }
    });

    // ==================== INITIALIZATION ====================
    
    // Set initial status
    setStatus("Waiting for inputs…", "idle");
  </script>
</body>
</html>
